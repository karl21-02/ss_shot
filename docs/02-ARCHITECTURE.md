# 02. 시스템 아키텍처 (System Architecture)

> Privacy-First Hybrid Architecture

---

## 1. 아키텍처 개요

SS-Shot은 **Privacy-First Hybrid Architecture**를 채택합니다.

핵심 원칙:
- **이미지 원본은 절대 서버로 전송하지 않음** (프라이버시 보호)
- **메타데이터(텍스트)만 클라우드에 저장** (검색 기능 제공)
- **OCR 처리는 On-Device에서 수행** (서버 비용 절감)

---

## 2. 시스템 구성도

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              USER DEVICE                                 │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                        FLUTTER APP                               │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │    │
│  │  │   Gallery   │  │   ML Kit    │  │     Local Storage       │  │    │
│  │  │   Access    │──│    OCR      │──│  (Drift + Secure)       │  │    │
│  │  │ (photo_mgr) │  │  (on-device)│  │                         │  │    │
│  │  └─────────────┘  └─────────────┘  └─────────────────────────┘  │    │
│  │         │                │                      │                │    │
│  │         │                │                      │                │    │
│  │         ▼                ▼                      ▼                │    │
│  │  ┌──────────────────────────────────────────────────────────┐   │    │
│  │  │                    SYNC ENGINE                            │   │    │
│  │  │  • 증분 스캔 (LastSyncedTime 기준)                         │   │    │
│  │  │  • OCR 결과 JSON 직렬화                                    │   │    │
│  │  │  • 네트워크 실패 시 PendingQueue 저장                       │   │    │
│  │  └──────────────────────────────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                    │                                     │
│                                    │ HTTPS (JSON)                        │
│                                    │ ※ 이미지 원본 미전송                  │
│                                    ▼                                     │
└─────────────────────────────────────────────────────────────────────────┘

                                     │
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                              AWS CLOUD                                   │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                     SPRING BOOT API SERVER                       │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │    │
│  │  │   Auth      │  │   Sync      │  │      Search             │  │    │
│  │  │   (JWT)     │  │   Service   │  │      Engine             │  │    │
│  │  └─────────────┘  └─────────────┘  └─────────────────────────┘  │    │
│  │         │                │                      │                │    │
│  │         │                │                      │                │    │
│  │         ▼                ▼                      ▼                │    │
│  │  ┌──────────────────────────────────────────────────────────┐   │    │
│  │  │                  CATEGORY CLASSIFIER                      │   │    │
│  │  │  • 키워드 기반 룰 엔진                                      │   │    │
│  │  │  • 금융/쇼핑/일정/유머/기타 분류                             │   │    │
│  │  └──────────────────────────────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                    │                                     │
│                                    │                                     │
│                                    ▼                                     │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                        AWS RDS (MySQL)                           │    │
│  │  ┌─────────────┐  ┌─────────────────────────────────────────┐   │    │
│  │  │   users     │  │        screenshot_metadata              │   │    │
│  │  │             │──│  • full_text (Full-Text Index)          │   │    │
│  │  │             │  │  • ocr_json (좌표 정보)                   │   │    │
│  │  │             │  │  • category (자동 분류 결과)              │   │    │
│  │  └─────────────┘  └─────────────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 컴포넌트별 역할

### 3.1 Client (Flutter App)

| 컴포넌트 | 역할 | 핵심 라이브러리 |
| --- | --- | --- |
| **Gallery Access** | 디바이스 갤러리 접근, Screenshots 앨범 로드 | `photo_manager` |
| **ML Kit OCR** | On-Device 텍스트 추출, 좌표 정보 획득 | `google_ml_kit` |
| **Local Storage** | JWT 토큰 저장, 동기화 대기열 관리 | `drift`, `flutter_secure_storage` |
| **Sync Engine** | 증분 스캔, 서버 동기화, 재시도 로직 | Custom |
| **UI Layer** | 사용자 인터페이스, 인터랙션 | Flutter Widgets |

### 3.2 Server (Spring Boot)

| 컴포넌트 | 역할 | 기술 |
| --- | --- | --- |
| **Auth Service** | 소셜 로그인, JWT 발급/검증 | Spring Security, OAuth2 |
| **Sync Service** | 메타데이터 수신, 저장, 삭제 처리 | JPA |
| **Search Engine** | Full-Text Search 쿼리 처리 | MySQL Full-Text Index |
| **Category Classifier** | 키워드 기반 자동 분류 | 룰 엔진 (확장 가능) |

### 3.3 Database (AWS RDS)

| 테이블 | 역할 | 인덱스 |
| --- | --- | --- |
| **users** | 사용자 정보 저장 | email (Unique) |
| **screenshot_metadata** | OCR 결과 메타데이터 | Full-Text (full_text), Composite (user_id, category) |

---

## 4. 데이터 흐름 (Data Flow)

### 4.1 스크린샷 동기화 흐름

```
[1] 앱 실행
      │
      ▼
[2] 갤러리 스캔 (LastSyncedTime 이후)
      │
      ▼
[3] 신규 이미지 감지
      │
      ├──────────────────────────────────────────┐
      ▼                                          │
[4] ML Kit OCR 수행                              │
      │                                          │
      ▼                                          │
[5] 텍스트 + 좌표 추출                            │ 이미지 원본은
      │                                          │ 로컬에만 보관
      ▼                                          │
[6] JSON 직렬화                                  │
      │                                          │
      ▼                                          │
[7] 서버 전송 (/api/sync)                        │
      │                                          │
      ├── 성공 ─────────────────────────────────┤
      │                                          │
      └── 실패 → PendingQueue 저장 → 재시도      │
                                                 │
                                                 │
[서버]                                           │
      │                                          │
      ▼                                          │
[8] 메타데이터 저장                               │
      │                                          │
      ▼                                          │
[9] 카테고리 자동 분류                            │
      │                                          │
      ▼                                          │
[10] DB 저장 완료 ◀─────────────────────────────┘
```

### 4.2 검색 흐름

```
[1] 사용자 검색어 입력 (예: "스타벅스")
      │
      ▼
[2] 클라이언트 → 서버 API 호출 (/api/search?q=스타벅스)
      │
      ▼
[3] Full-Text Search 쿼리 실행
      │  MATCH(full_text) AGAINST('스타벅스')
      │
      ▼
[4] 결과 반환 (local_id, full_text, ocr_json, category)
      │
      ▼
[5] 클라이언트: local_id로 로컬 이미지 로드
      │
      ▼
[6] ocr_json 좌표로 검색어 위치 하이라이팅
      │
      ▼
[7] 결과 화면 표시
```

---

## 5. 통신 프로토콜

### 5.1 API 통신

- **Protocol:** HTTPS (TLS 1.3)
- **Format:** JSON
- **Authentication:** Bearer Token (JWT)

### 5.2 요청/응답 예시

**동기화 요청:**
```json
POST /api/sync
Authorization: Bearer {access_token}

{
  "screenshots": [
    {
      "localId": "IMG_9981",
      "fullText": "스타벅스 아메리카노 4,500원 결제 완료",
      "blocks": [
        {"text": "스타벅스", "rect": {"x": 100, "y": 200, "w": 80, "h": 25}},
        {"text": "4,500원", "rect": {"x": 100, "y": 250, "w": 60, "h": 20}}
      ],
      "capturedAt": "2026-01-08T10:30:00Z"
    }
  ]
}
```

**검색 응답:**
```json
GET /api/search?q=스타벅스
Authorization: Bearer {access_token}

{
  "results": [
    {
      "localId": "IMG_9981",
      "category": "SHOPPING",
      "matchedText": "스타벅스 아메리카노 4,500원",
      "blocks": [
        {"text": "스타벅스", "rect": {"x": 100, "y": 200, "w": 80, "h": 25}}
      ],
      "capturedAt": "2026-01-08T10:30:00Z"
    }
  ],
  "totalCount": 1
}
```

---

## 6. 확장성 고려사항

### 6.1 현재 (MVP)

- 단일 서버 인스턴스
- 룰 기반 카테고리 분류

### 6.2 향후 확장

| 영역 | 현재 | 확장 계획 |
| --- | --- | --- |
| **서버** | EC2 단일 인스턴스 | Auto Scaling + Load Balancer |
| **분류** | 키워드 룰 엔진 | ML 모델 (자연어 처리) |
| **검색** | MySQL Full-Text | Elasticsearch |
| **캐싱** | 없음 | Redis |

---

## 7. 참고 문서

- [03-TECH_STACK.md](./03-TECH_STACK.md) - 상세 기술 스택
- [06-DB_SCHEMA.md](./06-DB_SCHEMA.md) - 데이터베이스 설계
